# this is for grpc client
services:
  triton-server:
    build: .
    container_name: phone-detection

    # Temporarily disable CUDA to test MMPose on CPU
    runtime: runc
    environment:
      - CUDA_VISIBLE_DEVICES=""
      - NVIDIA_VISIBLE_DEVICES=""

    ports:
      - "8010:8000"    # HTTP endpoint
      - "8011:8001"    # gRPC endpoint
      - "8012:8002"    # Metrics endpoint

    volumes:
      - ../models/model_repository:/models:ro
      - ./logs:/logs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/v2/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped

  triton-client:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: triton-client
    depends_on:
      - triton-server
    volumes:
      - .:/workspace
    tty: true
    stdin_open: true
    command: /bin/bash

    # Temporarily disable CUDA for testing
    runtime: runc
    environment:
      - CUDA_VISIBLE_DEVICES=""
      - NVIDIA_VISIBLE_DEVICES=""

    restart: "no"
